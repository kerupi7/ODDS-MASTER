<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ODDS MASTER</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Modern Calendar Styling */
        input[type="date"] {
            position: relative;
            background: white;
            cursor: pointer;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }
        
        input[type="date"]:hover {
            border-color: #10b981;
        }
        
        input[type="date"]:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* Mobile input optimization */
        input[type="number"] {
            font-size: 16px; /* Prevent zoom on iOS */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // --- Icon System (Fixed: Using Inline SVGs instead of external script) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Settings: (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Calculator: (props) => <IconBase {...props}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>,
            Trash2: (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            Info: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            Layers: (props) => <IconBase {...props}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></IconBase>,
            GitMerge: (props) => <IconBase {...props}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></IconBase>,
            PlusCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            CheckSquare: (props) => <IconBase {...props}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>,
            Calendar: (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            MapPin: (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Flag: (props) => <IconBase {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>,
            History: (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>,
            ArrowLeft: (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>,
            CheckCircle: (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            AlertCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            BookOpen: (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
            BarChart: (props) => <IconBase {...props}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconBase>,
            TrendingUp: (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>,
            ChevronDown: (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>,
            ChevronUp: (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>,
            Award: (props) => <IconBase {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconBase>,
            DollarSign: (props) => <IconBase {...props}><line x1="12" x2="12" y1="1" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            Upload: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
        };

        // Course Accordion Component
        const CourseAccordion = ({ courseName, data }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            
            return (
                <div className="bg-white rounded-lg shadow border border-gray-100 overflow-hidden">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full p-4 flex items-center justify-between hover:bg-gray-50 transition-colors text-left"
                    >
                        <div className="flex items-center gap-3">
                            <div className={`p-2 rounded-full ${isOpen ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'}`}>
                                <Icons.Flag size={18} />
                            </div>
                            <div>
                                <h4 className="text-sm font-bold text-gray-800">{courseName}</h4>
                                <p className="text-xs text-gray-500 truncate max-w-[200px]">{data.overview}</p>
                            </div>
                        </div>
                        <div>
                            {isOpen ? <Icons.ChevronUp size={20} className="text-gray-400" /> : <Icons.ChevronDown size={20} className="text-gray-400" />}
                        </div>
                    </button>

                    {isOpen && (
                        <div className="p-4 pt-0 border-t border-gray-100 bg-gray-50/50">
                            <div className="space-y-4 mt-3">
                                
                                <div className="bg-white p-3 rounded border border-gray-200">
                                    <h5 className="text-xs font-bold text-gray-500 mb-2 uppercase flex items-center gap-1">
                                        <Icons.Info size={12} /> „Ç≥„Éº„ÇπÁâπÂæ¥
                                    </h5>
                                    <ul className="text-sm text-gray-700 space-y-1 list-disc list-inside">
                                        {data.features.map((f, i) => <li key={i}>{f}</li>)}
                                    </ul>
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div className="bg-white p-3 rounded border border-gray-200">
                                        <h5 className="text-xs font-bold text-gray-500 mb-2 uppercase">ËÑöË≥™ÂÇæÂêë</h5>
                                        <div className="space-y-2 text-sm">
                                            {Object.entries(data.style).map(([key, val]) => {
                                                const label = { escape: 'ÈÄÉ„Åí', lead: 'ÂÖàË°å', chase: 'Â∑Æ„Åó', late: 'ËøΩËæº' }[key];
                                                return (
                                                    <div key={key} className="flex justify-between border-b border-gray-100 pb-1 last:border-0">
                                                        <span className="font-semibold text-gray-600">{label}</span>
                                                        <div className="text-right">
                                                            {val.return && <span className="text-emerald-600 font-bold mr-2">Âõû{val.return}</span>}
                                                            {val.note && <span className="text-xs text-gray-400">{val.note}</span>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="bg-white p-3 rounded border border-gray-200">
                                        <h5 className="text-xs font-bold text-gray-500 mb-2 uppercase">Êû†È†ÜÂÇæÂêë</h5>
                                        <div className="space-y-2 text-sm">
                                            <div className="text-emerald-700"><span className="font-bold">‚óé</span> {data.frame.good}</div>
                                            <div className="text-orange-600"><span className="font-bold">‚ñ≤</span> {data.frame.bad}</div>
                                            <div className="text-red-600"><span className="font-bold">‚úï</span> {data.frame.worst}</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-3 rounded border border-gray-200">
                                    <h5 className="text-xs font-bold text-gray-500 mb-2 uppercase">Ë°ÄÁµ±ÂÇæÂêë</h5>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Â•ΩËµ∞:</span>
                                        {data.blood.good.map((b, i) => <span key={i} className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-700">{b}</span>)}
                                    </div>
                                    {data.blood.bad.length > 0 && (
                                        <div className="flex flex-wrap gap-2">
                                            <span className="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded">‰∏çÊåØ:</span>
                                            {data.blood.bad.map((b, i) => <span key={i} className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-700">{b}</span>)}
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div className="bg-blue-50 p-3 rounded border border-blue-100">
                                        <h5 className="text-xs font-bold text-blue-700 mb-1 flex items-center gap-1"><Icons.CheckCircle size={12}/> Ëª∏„ÅÆ„Éù„Ç§„É≥„Éà</h5>
                                        <ul className="text-xs text-blue-900 space-y-1">
                                            {data.axis.map((t, i) => <li key={i}>„Éª{t}</li>)}
                                        </ul>
                                    </div>
                                    <div className="bg-yellow-50 p-3 rounded border border-yellow-100">
                                        <h5 className="text-xs font-bold text-yellow-700 mb-1 flex items-center gap-1"><Icons.AlertCircle size={12}/> Á©¥„ÅÆ„Éù„Ç§„É≥„Éà</h5>
                                        <ul className="text-xs text-yellow-900 space-y-1">
                                            {data.hole.map((t, i) => <li key={i}>„Éª{t}</li>)}
                                        </ul>
                                    </div>
                                </div>

                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HorseRacingOddsManager = () => {
            // State Definitions
            const [currentView, setCurrentView] = useState('calculator');
            const [raceMeta, setRaceMeta] = useState({
                date: new Date().toISOString().split('T')[0],
                place: 'Êù±‰∫¨',
                raceNum: 11,
                note: ''
            });

            const [horseCount, setHorseCount] = useState(18); 
            const [betType, setBetType] = useState('tansho');
            const [votingMode, setVotingMode] = useState('box'); 
            
            const [axisHorse, setAxisHorse] = useState(null); 
            const [opponentHorses, setOpponentHorses] = useState([]); 
            const [formation, setFormation] = useState({ first: [], second: [], third: [] });
            const [boxHorses, setBoxHorses] = useState([]);

            const [betList, setBetList] = useState([]); 
            const [oddsData, setOddsData] = useState({}); 
            const [customStakes, setCustomStakes] = useState({}); 
            const [totalBudget, setTotalBudget] = useState(10000); 
            const [allocationMode, setAllocationMode] = useState('profit'); 
            const [budgetInputMode, setBudgetInputMode] = useState('budget'); 
            const [targetProfit, setTargetProfit] = useState(10000);
            const [targetError, setTargetError] = useState(null); 

            const [savedHistory, setSavedHistory] = useState([]);
            
            // Bankroll Management State
            const [bankrollStart, setBankrollStart] = useState(() => {
                const saved = localStorage.getItem('bankroll_start');
                return saved ? parseInt(saved) : 30000;
            });
            const [bankrollGoal, setBankrollGoal] = useState(() => {
                const saved = localStorage.getItem('bankroll_goal');
                return saved ? parseInt(saved) : 10000;
            });
            const [bankrollCurrent, setBankrollCurrent] = useState(() => {
                const saved = localStorage.getItem('bankroll_current');
                return saved ? parseInt(saved) : 30000;
            });
            const [bankrollHistory, setBankrollHistory] = useState(() => {
                const saved = localStorage.getItem('bankroll_history');
                return saved ? JSON.parse(saved) : [];
            });

            const [showBankroll, setShowBankroll] = useState(true);
            
            // Á¢∫ÂÆö„Ç™„ÉÉ„Ç∫ÂÖ•ÂäõÁî®„Çπ„ÉÜ„Éº„Éà
            const [showOddsConfirm, setShowOddsConfirm] = useState(false);
            const [currentWinningBets, setCurrentWinningBets] = useState([]);
            const [finalOddsMap, setFinalOddsMap] = useState({});
            const [tempRaceResultData, setTempRaceResultData] = useState(null); // Á¢∫ÂÆöÂæÖ„Å°„ÅÆ‰∏ÄÊôÇ„Éá„Éº„Çø

            const [toast, setToast] = useState(null);
            const [confirmModal, setConfirmModal] = useState(null);
            
            const [showCalendar, setShowCalendar] = useState(false);
            const [calendarDate, setCalendarDate] = useState(new Date());
            const [raceResult, setRaceResult] = useState({ first: '', second: '', third: '' });
            const [showResultInput, setShowResultInput] = useState(false);
            const [resultHistory, setResultHistory] = useState([]);
            const [showCourseData, setShowCourseData] = useState(false);
            const [selectedCourse, setSelectedCourse] = useState(null);
            
            // „Ç≥„Éº„Çπ„Éá„Éº„Çø„ÇíState„ÅßÁÆ°ÁêÜ
            const [courseData, setCourseData] = useState({});

            // Show toast helper
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };
            
            // Â§ñÈÉ®„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÔºà„É≠„Éº„Ç´„É´„Çµ„Éº„Éê„ÉºÁí∞Â¢ÉÁî®Ôºâ
            useEffect(() => {
                fetch('course-data.json')
                    .then(res => {
                        if (!res.ok) throw new Error("File not found");
                        return res.json();
                    })
                    .then(data => setCourseData(data))
                    .catch(err => console.log('JSONË™≠„ÅøËæº„ÅøÂ§±ÊïóÔºàÊâãÂãï„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ', err));
            }, []);

            // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éè„É≥„Éâ„É©
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        setCourseData(json);
                        showToast('„Ç≥„Éº„Çπ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                    } catch (err) {
                        showToast('JSON„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            // Show confirmation modal
            const showConfirm = (message, onConfirm) => {
                setConfirmModal({ message, onConfirm });
            };
            
            // Handle confirm
            const handleConfirm = () => {
                if (confirmModal?.onConfirm) {
                    confirmModal.onConfirm();
                }
                setConfirmModal(null);
            };
            
            // Calendar helpers
            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                
                return { daysInMonth, startingDayOfWeek, year, month };
            };
            
            const selectDate = (day) => {
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();
                const selectedDate = new Date(year, month, day);
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                setRaceMeta(prev => ({ ...prev, date: dateString }));
                setShowCalendar(false);
            };
            
            const changeMonth = (delta) => {
                setCalendarDate(prev => {
                    const newDate = new Date(prev);
                    newDate.setMonth(newDate.getMonth() + delta);
                    return newDate;
                });
            };

            // Load history
            useEffect(() => {
                const saved = localStorage.getItem('jra_odds_history');
                if (saved) {
                    try {
                        setSavedHistory(JSON.parse(saved));
                    } catch (e) {
                        console.error("Failed to load history", e);
                    }
                }
                
                const savedResults = localStorage.getItem('jra_odds_results');
                if (savedResults) {
                    try {
                        setResultHistory(JSON.parse(savedResults));
                    } catch (e) {
                        console.error("Failed to load results", e);
                    }
                }
            }, []);
            
            // Save bankroll data
            useEffect(() => {
                localStorage.setItem('bankroll_start', bankrollStart.toString());
            }, [bankrollStart]);
            
            useEffect(() => {
                localStorage.setItem('bankroll_goal', bankrollGoal.toString());
            }, [bankrollGoal]);
            
            useEffect(() => {
                localStorage.setItem('bankroll_current', bankrollCurrent.toString());
            }, [bankrollCurrent]);
            
            // Update calendar
            useEffect(() => {
                if (raceMeta.date) {
                    setCalendarDate(new Date(raceMeta.date));
                }
            }, [raceMeta.date]);

            // Meta Change
            const handleMetaChange = (field, value) => {
                if (betList.length > 0) {
                    showConfirm('„É¨„Éº„ÇπÊÉÖÂ†±„ÇíÂ§âÊõ¥„Åô„Çã„Å®„ÄÅÁèæÂú®„ÅÆË≤∑„ÅÑÁõÆ„É™„Çπ„Éà„Å®„Ç™„ÉÉ„Ç∫„ÅØ„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ', () => {
                        setRaceMeta(prev => ({ ...prev, [field]: value }));
                        setBetList([]);
                        setOddsData({});
                    });
                } else {
                    setRaceMeta(prev => ({ ...prev, [field]: value }));
                }
            };

            // Nagashi
            const handleNagashiClick = (number) => {
                if (axisHorse === number) {
                    setAxisHorse(null);
                } else if (opponentHorses.includes(number)) {
                    setOpponentHorses(prev => prev.filter(h => h !== number));
                } else {
                    if (axisHorse === null) {
                        setAxisHorse(number);
                    } else {
                        setOpponentHorses(prev => [...prev, number].sort((a, b) => a - b));
                    }
                }
            };

            // Formation
            const toggleFormationHorse = (rowKey, number) => {
                setFormation(prev => {
                    const currentList = prev[rowKey];
                    if (currentList.includes(number)) {
                        return { ...prev, [rowKey]: currentList.filter(n => n !== number) };
                    } else {
                        return { ...prev, [rowKey]: [...currentList, number].sort((a, b) => a - b) };
                    }
                });
            };

            // Box
            const toggleBoxHorse = (number) => {
                setBoxHorses(prev => {
                    if (prev.includes(number)) {
                        return prev.filter(n => n !== number);
                    } else {
                        return [...prev, number].sort((a, b) => a - b);
                    }
                });
            };

            // Clears
            const clearSelection = () => {
                setAxisHorse(null);
                setOpponentHorses([]);
                setFormation({ first: [], second: [], third: [] });
                setBoxHorses([]);
            };

            const clearAll = () => {
                showConfirm('ÁèæÂú®„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„Çí„Åô„Åπ„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü', () => {
                    clearSelection();
                    setBetList([]);
                    setOddsData({});
                    setRaceMeta({
                        date: new Date().toISOString().split('T')[0],
                        place: 'Êù±‰∫¨',
                        raceNum: 11,
                        note: ''
                    });
                    setBetType('tansho');
                    setVotingMode('box');
                    setTotalBudget(10000);
                    setAllocationMode('profit');
                });
            };

            // Bet Type
            const handleBetTypeChange = (type) => {
                setBetType(type);
                if (type === 'tansho' || type === 'fukusho') {
                    setVotingMode('box');
                } else {
                    setVotingMode('nagashi');
                }
            };

            // History Save/Load/Delete
            const saveToHistory = () => {
                if (betList.length === 0) {
                    showToast('‰øùÂ≠ò„Åô„ÇãË≤∑„ÅÑÁõÆ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                    return;
                }

                const newEntry = {
                    id: Date.now(),
                    meta: { ...raceMeta },
                    data: {
                        betList: [...betList],
                        oddsData: { ...oddsData },
                        totalBudget,
                        allocationMode
                    },
                    savedAt: new Date().toISOString()
                };

                const newHistory = [newEntry, ...savedHistory];
                setSavedHistory(newHistory);
                localStorage.setItem('jra_odds_history', JSON.stringify(newHistory));
                
                showToast(`${raceMeta.place} ${raceMeta.raceNum}R „Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü (${betList.length}ÁÇπ)`, 'success');
            };

            const loadFromHistory = (entry) => {
                showConfirm('ÁèæÂú®„ÅÆÁ∑®ÈõÜÂÜÖÂÆπ„ÇíÁ†¥Ê£Ñ„Åó„Å¶„ÄÅ‰øùÂ≠ò„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü', () => {
                    clearSelection();
                    setRaceMeta({ ...entry.meta });
                    setBetList([...entry.data.betList]);
                    setOddsData({ ...entry.data.oddsData });
                    setTotalBudget(entry.data.totalBudget || 10000);
                    setAllocationMode(entry.data.allocationMode || 'profit');
                    
                    setCurrentView('calculator');

                    setTimeout(() => {
                        showToast(`${entry.meta.place} ${entry.meta.raceNum}R „ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü (${entry.data.betList.length}ÁÇπ)`, 'success');
                    }, 100);

                    setTimeout(() => {
                        const listSection = document.getElementById('bet-list-section');
                        if (listSection) {
                            listSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 300);
                });
            };

            const deleteHistoryItem = (id) => {
                showConfirm('„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', () => {
                    const newHistory = savedHistory.filter(item => item.id !== id);
                    setSavedHistory(newHistory);
                    localStorage.setItem('jra_odds_history', JSON.stringify(newHistory));
                    showToast('Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                });
            };

            // Áµ±Ë®à„Éá„Éº„Çø„ÅÆÂÖ®ÂâäÈô§Ê©üËÉΩ
            const clearStats = () => {
                showConfirm('ÂÖ®„Å¶„ÅÆÁµ±Ë®à„Éá„Éº„ÇøÔºàÁöÑ‰∏≠Âà§ÂÆö„ÅÆÂ±•Ê≠¥Ôºâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ', () => {
                    setResultHistory([]);
                    localStorage.setItem('jra_odds_results', JSON.stringify([]));
                    showToast('Áµ±Ë®à„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                });
            };

            // Combination Generator
            const previewCombinations = useMemo(() => {
                let combos = [];
                const sortNums = (arr) => arr.sort((a, b) => a - b);

                if (votingMode === 'box') {
                    if (boxHorses.length === 0) return [];
                    const horses = [...boxHorses];

                    if (betType === 'tansho' || betType === 'fukusho') {
                        horses.forEach(h => {
                            combos.push({ ids: [h], key: `${betType}:${h}`, label: `${h}Áï™`, type: betType });
                        });
                    } else if (betType === 'umaren' || betType === 'wide') {
                        for (let i = 0; i < horses.length; i++) {
                            for (let j = i + 1; j < horses.length; j++) {
                                const sorted = sortNums([horses[i], horses[j]]);
                                combos.push({ ids: sorted, key: `${betType}:${sorted.join('-')}`, label: sorted.join('-'), type: betType });
                            }
                        }
                    } else if (betType === 'umatan') {
                        for (let i = 0; i < horses.length; i++) {
                            for (let j = 0; j < horses.length; j++) {
                                if (i === j) continue;
                                const combo = [horses[i], horses[j]];
                                combos.push({ ids: combo, key: `${betType}:${combo.join('>')}`, label: combo.join('>'), type: betType });
                            }
                        }
                    } else if (betType === 'sanrenpuku') {
                        for (let i = 0; i < horses.length; i++) {
                            for (let j = i + 1; j < horses.length; j++) {
                                for (let k = j + 1; k < horses.length; k++) {
                                    const sorted = sortNums([horses[i], horses[j], horses[k]]);
                                    combos.push({ ids: sorted, key: `${betType}:${sorted.join('-')}`, label: sorted.join('-'), type: betType });
                                }
                            }
                        }
                    } else if (betType === 'sanrentan') {
                        for (let i = 0; i < horses.length; i++) {
                            for (let j = 0; j < horses.length; j++) {
                                for (let k = 0; k < horses.length; k++) {
                                    if (i === j || j === k || i === k) continue;
                                    const combo = [horses[i], horses[j], horses[k]];
                                    combos.push({ ids: combo, key: `${betType}:${combo.join('>')}`, label: combo.join('>'), type: betType });
                                }
                            }
                        }
                    }
                } else if (votingMode === 'nagashi') {
                    if (!axisHorse || opponentHorses.length === 0) return [];
                    const opps = [...opponentHorses];

                    if (betType === 'umaren' || betType === 'wide') {
                        opps.forEach(opp => {
                            const combo = sortNums([axisHorse, opp]);
                            combos.push({ ids: combo, key: `${betType}:${combo.join('-')}`, label: combo.join('-'), type: betType });
                        });
                    } else if (betType === 'umatan') {
                        opps.forEach(opp => {
                            const combo = [axisHorse, opp];
                            combos.push({ ids: combo, key: `${betType}:${combo.join('>')}`, label: combo.join('>'), type: betType });
                        });
                    } else if (betType === 'sanrenpuku') {
                        if (opps.length < 2) return [];
                        for (let i = 0; i < opps.length; i++) {
                            for (let j = i + 1; j < opps.length; j++) {
                                const raw = [axisHorse, opps[i], opps[j]];
                                const sorted = sortNums(raw);
                                combos.push({ ids: sorted, key: `${betType}:${sorted.join('-')}`, label: sorted.join('-'), type: betType });
                            }
                        }
                    } else if (betType === 'sanrentan') {
                        if (opps.length < 2) return [];
                        for (let i = 0; i < opps.length; i++) {
                            for (let j = 0; j < opps.length; j++) {
                                if (i === j) continue;
                                const combo = [axisHorse, opps[i], opps[j]];
                                combos.push({ ids: combo, key: `${betType}:${combo.join('>')}`, label: combo.join('>'), type: betType });
                            }
                        }
                    }
                } else if (votingMode === 'formation') {
                    const { first, second, third } = formation;
                    const isUnique = (arr) => new Set(arr).size === arr.length;

                    if (betType === 'umaren' || betType === 'wide') {
                        if (first.length === 0 || second.length === 0) return [];
                        const seen = new Set();
                        first.forEach(f => {
                            second.forEach(s => {
                                if (f === s) return;
                                const sorted = sortNums([f, s]);
                                const uniqueKey = sorted.join('-');
                                if (!seen.has(uniqueKey)) {
                                    seen.add(uniqueKey);
                                    combos.push({ ids: sorted, key: `${betType}:${uniqueKey}`, label: uniqueKey, type: betType });
                                }
                            });
                        });
                    } else if (betType === 'umatan') {
                        if (first.length === 0 || second.length === 0) return [];
                        first.forEach(f => {
                            second.forEach(s => {
                                if (f === s) return;
                                const label = `${f}>${s}`;
                                combos.push({ ids: [f, s], key: `${betType}:${label}`, label, type: betType });
                            });
                        });
                    } else if (betType === 'sanrenpuku') {
                        if (first.length === 0 || second.length === 0 || third.length === 0) return [];
                        const seen = new Set();
                        first.forEach(f => {
                            second.forEach(s => {
                                third.forEach(t => {
                                    if (!isUnique([f, s, t])) return;
                                    const sorted = sortNums([f, s, t]);
                                    const uniqueKey = sorted.join('-');
                                    if (!seen.has(uniqueKey)) {
                                        seen.add(uniqueKey);
                                        combos.push({ ids: sorted, key: `${betType}:${uniqueKey}`, label: uniqueKey, type: betType });
                                    }
                                });
                            });
                        });
                    } else if (betType === 'sanrentan') {
                        if (first.length === 0 || second.length === 0 || third.length === 0) return [];
                        first.forEach(f => {
                            second.forEach(s => {
                                third.forEach(t => {
                                    if (!isUnique([f, s, t])) return;
                                    const label = `${f}>${s}>${t}`;
                                    combos.push({ ids: [f, s, t], key: `${betType}:${label}`, label, type: betType });
                                });
                            });
                        });
                    }
                }

                return combos;
            }, [axisHorse, opponentHorses, formation, boxHorses, betType, votingMode]);

            const addBetsToList = () => {
                if (previewCombinations.length === 0) return;
                setBetList(prev => {
                    const existingKeys = new Set(prev.map(b => b.key));
                    const newBets = previewCombinations.filter(b => !existingKeys.has(b.key));
                    return [...prev, ...newBets];
                });
            };

            const removeBet = (key) => {
                setBetList(prev => prev.filter(b => b.key !== key));
            };

            const handleOddsChange = (key, value, oddsType = 'default') => {
                if (oddsType === 'default') {
                    setOddsData(prev => ({ ...prev, [key]: parseFloat(value) }));
                } else {
                    setOddsData(prev => ({
                        ...prev,
                        [key]: {
                            ...(typeof prev[key] === 'object' ? prev[key] : {}),
                            [oddsType]: parseFloat(value)
                        }
                    }));
                }
            };

            // ‰øÆÊ≠£: Á©∫ÊñáÂ≠ó„ÇíË®±ÂÆπ„Åó„ÄÅÂãùÊâã„Å´0„Å´Â§âÊèõ„Åó„Å™„ÅÑ
            const handleStakeChange = (key, value) => {
                const val = value === '' ? '' : parseInt(value);
                setCustomStakes(prev => ({ ...prev, [key]: val }));
            };

            const calculateBudgetFromTarget = () => {
                setTargetError(null);
                
                if (betList.length === 0) {
                    setTargetError('Ë≤∑„ÅÑÁõÆ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                let inverseSum = 0;
                let hasValidOdds = false;
                
                for (const bet of betList) {
                    const odds = oddsData[bet.key];
                    if (bet.type === 'wide') {
                        if (odds && typeof odds === 'object' && (odds.min > 0 || odds.max > 0)) {
                            const avgOdds = ((odds.min || 0) + (odds.max || 0)) / 2;
                            if (avgOdds > 0) {
                                inverseSum += 1 / avgOdds;
                                hasValidOdds = true;
                            }
                        }
                    } else {
                        if (odds > 0) {
                            inverseSum += 1 / odds;
                            hasValidOdds = true;
                        }
                    }
                }
                
                if (!hasValidOdds) {
                    setTargetError('„Ç™„ÉÉ„Ç∫„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (inverseSum >= 1.0) {
                    setTargetError('‚ö†Ô∏è „Ç™„ÉÉ„Ç∫„Åå‰Ωé„Åô„Åé„Åæ„Åô„ÄÇÁõÆÊ®ôÈÅîÊàê„ÅØ‰∏çÂèØËÉΩ„Åß„Åô„ÄÇ');
                    return;
                }
                
                // ‰øÆÊ≠£: targetProfit„ÅåÁ©∫ÊñáÂ≠ó„ÅÆÂ†¥Âêà„ÅØ0„Å®„Åó„Å¶Êâ±„ÅÜ
                const target = targetProfit === '' ? 0 : targetProfit;
                const totalPayout = target / (1 - inverseSum);
                const requiredBudget = Math.ceil((totalPayout - target) / 100) * 100; 
                
                setTotalBudget(requiredBudget);
                setAllocationMode('profit'); 
                setCustomStakes({}); 
            };

            // „Éê„É≥„ÇØ„É≠„Éº„É´Â±•Ê≠¥Êìç‰ΩúÈñ¢Êï∞
            const saveBankrollSession = () => {
                const start = bankrollStart === '' ? 0 : parseInt(bankrollStart);
                const current = bankrollCurrent === '' ? 0 : parseInt(bankrollCurrent);
                const goal = bankrollGoal === '' ? 0 : parseInt(bankrollGoal);

                const profit = current - start;
                const profitPercentage = start > 0 ? ((profit / start) * 100).toFixed(1) : 0;
                
                const newRecord = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ja-JP'),
                    start: start,
                    end: current,
                    goal: goal,
                    profit: profit,
                    percent: profitPercentage,
                    isGoal: current >= (start + goal)
                };

                const newHistory = [newRecord, ...bankrollHistory];
                setBankrollHistory(newHistory);
                localStorage.setItem('bankroll_history', JSON.stringify(newHistory));
                
                showToast('Êú¨Êó•„ÅÆÂèéÊîØ„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü', 'success');
            };

            const resetBankrollSession = () => {
                showConfirm('ÁèæÂú®„ÅÆË®òÈå≤„Çí‰øùÂ≠ò„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü\nÔºàÈñãÂßãË≥áÈáë„ÉªÁõÆÊ®ôÂà©Áõä„ÉªÁèæÂú®Ë≥áÈáë„ÅØ„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„ÅôÔºâ', () => {
                    saveBankrollSession();
                    // ÂÖ®„Å¶„É™„Çª„ÉÉ„ÉàÔºàÁ©∫ÊñáÂ≠ó„Å´Ë®≠ÂÆö„Åó„Å¶Á©∫Ê¨Ñ„Å´„Åô„ÇãÔºâ
                    setBankrollStart('');
                    setBankrollGoal('');
                    setBankrollCurrent('');
                });
            };

            const deleteBankrollRecord = (id) => {
                showConfirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', () => {
                    const newHistory = bankrollHistory.filter(item => item.id !== id);
                    setBankrollHistory(newHistory);
                    localStorage.setItem('bankroll_history', JSON.stringify(newHistory));
                    showToast('Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                });
            };

            // Check which bets won based on race result
            const checkResults = () => {
                const { first, second, third } = raceResult;
                
                if (!first || !second || !third) {
                    showToast('ÁùÄÈ†Ü„ÇíÂÖ®„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }

                // Êï∞ÂÄ§„Å®„Åó„Å¶Á¢∫ÂÆü„Å´Êâ±„ÅÜ„Åü„ÇÅ„Å´Â§âÊèõ
                const r1 = parseInt(first);
                const r2 = parseInt(second);
                const r3 = parseInt(third);
                
                const results = betList.map(bet => {
                    let isWin = false;
                    // bet.ids „ÅØÊï∞ÂÄ§ÈÖçÂàó„ÅÆ„ÅØ„Åö„Å†„Åå„ÄÅÂøµ„ÅÆ„Åü„ÇÅÁ¢∫Ë™ç
                    const ids = bet.ids.map(id => parseInt(id));

                    switch (bet.type) {
                        case 'tansho': 
                            isWin = ids[0] === r1; 
                            break;
                        case 'fukusho': 
                            isWin = ids[0] === r1 || ids[0] === r2 || ids[0] === r3; 
                            break;
                        case 'wide': 
                            // 3ÁùÄ„Åæ„Åß„Å´ÂÖ•„ÇãÈ¶¨Áï™„ÅÆ„É™„Çπ„Éà
                            const winners = [r1, r2, r3];
                            // Ëá™ÂàÜ„ÅÆË≤∑„ÅÑÁõÆ(2È†≠)„Åå‰∏°Êñπ„Å®„ÇÇ3ÁùÄ‰ª•ÂÜÖ„Å´ÂÖ•„Å£„Å¶„ÅÑ„Çã„Åã
                            isWin = winners.includes(ids[0]) && winners.includes(ids[1]);
                            break;
                        case 'umaren': 
                            const umarenWinners = [r1, r2]; // 1,2ÁùÄ
                            // È†Ü‰∏çÂêå„Åß‰∏ÄËá¥„Åô„Çã„ÅãÔºàË≤∑„ÅÑÁõÆ„ÇÇÁµêÊûú„ÇÇ2È†≠Ôºâ
                            // ÂçòÁ¥î„Å´„ÄÅËá™ÂàÜ„ÅÆ2È†≠„Åå[r1, r2]„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            isWin = umarenWinners.includes(ids[0]) && umarenWinners.includes(ids[1]);
                            break;
                        case 'umatan': 
                            isWin = (ids[0] === r1 && ids[1] === r2); 
                            break;
                        case 'sanrenpuku': 
                            const sanrenWinners = [r1, r2, r3];
                            isWin = sanrenWinners.includes(ids[0]) && sanrenWinners.includes(ids[1]) && sanrenWinners.includes(ids[2]);
                            break;
                        case 'sanrentan': 
                            isWin = (ids[0] === r1 && ids[1] === r2 && ids[2] === r3); 
                            break;
                    }
                    return { ...bet, isWin };
                });
                
                const totalInvested = calculatedData.reduce((sum, bet) => sum + (bet.stake || 0), 0);

                // ÁöÑ‰∏≠„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
                const winning = results.filter(r => r.isWin);
                
                if (winning.length > 0) {
                    // ÁöÑ‰∏≠„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÁ¢∫ÂÆö„Ç™„ÉÉ„Ç∫ÂÖ•Âäõ„Éï„Çß„Éº„Ç∫„Å∏ÁßªË°å
                    const initialFinalOdds = {};
                    winning.forEach(bet => {
                        // ÂàùÊúüÂÄ§„Å®„Åó„Å¶„ÄÅÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åü‰∫àÊÉ≥„Ç™„ÉÉ„Ç∫Ôºà„ÉØ„Ç§„Éâ„ÅÆÂ†¥Âêà„ÅØminÔºâ„Çí‰ΩøÁî®
                        let defaultOdds = '';
                        if (bet.type === 'wide') {
                            const wideOdds = oddsData[bet.key];
                            defaultOdds = wideOdds && typeof wideOdds === 'object' ? wideOdds.min : '';
                        } else {
                            defaultOdds = oddsData[bet.key] || '';
                        }
                        initialFinalOdds[bet.key] = defaultOdds;
                    });
                    
                    setFinalOddsMap(initialFinalOdds);
                    setCurrentWinningBets(winning);
                    setTempRaceResultData({ results, totalInvested }); // Á¢∫ÂÆöÂá¶ÁêÜ„Å´ÂøÖË¶Å„Å™„Éá„Éº„Çø„Çí‰øùÊåÅ
                    setShowOddsConfirm(true);
                    return;
                }
                
                // ÁöÑ‰∏≠„Å™„Åó„ÅÆÂ†¥Âêà„ÅØ„ÄåÁöÑ‰∏≠„Å™„Åó„Äç„É°„ÉÉ„Çª„Éº„Ç∏„Å®ÂÖ±„Å´Á¢∫ÂÆö
                const profit = -totalInvested; // ÂÖ®È°çÊ≤°Âèé
                const current = bankrollCurrent === '' ? 0 : parseInt(bankrollCurrent);
                const newBankroll = current + profit;
                
                // Á¢∫ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÂá∫„ÅôÂâç„Å´„ÄÅ„É¶„Éº„Ç∂„Éº„Å´„Äå„ÅØ„Åö„Çå„Äç„Åß„ÅÇ„Çã„Åì„Å®„Çí‰ºù„Åà„Çã
                const resultMessage = `ÊÆãÂøµ...ÁöÑ‰∏≠„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ
ÊäïË≥áÈ°ç: ${totalInvested.toLocaleString()}ÂÜÜ
ÂõûÂèé: 0ÂÜÜ
ÂèéÊîØ: ${profit.toLocaleString()}ÂÜÜ

üí∞ Ë≥áÈáëÊõ¥Êñ∞: ${current.toLocaleString()}ÂÜÜ ‚Üí ${newBankroll.toLocaleString()}ÂÜÜ`;

                showConfirm(
                    resultMessage,
                    () => {
                        // OK„ÇíÊäº„Åó„Åü„ÇâÁ¢∫ÂÆöÂá¶ÁêÜÔºàÁöÑ‰∏≠„Å™„Åó„Å®„Åó„Å¶‰øùÂ≠òÔºâ
                        finalizeBatch(results, totalInvested, {});
                    }
                );
            };

            // Á¢∫ÂÆöÂá¶ÁêÜ„ÅÆÂÆüË°å
            const finalizeBatch = (results, totalInvested, finalOdds) => {
                const winCount = results.filter(r => r.isWin).length;

                const totalReturn = results.reduce((sum, bet) => {
                    if (!bet.isWin) return sum;
                    const betData = calculatedData.find(row => row.key === bet.key);
                    if (!betData) return sum;
                    
                    // Á¢∫ÂÆö„Ç™„ÉÉ„Ç∫ÔºàfinalOddsÔºâ„Çí‰ΩøÁî®
                    const actualOdds = parseFloat(finalOdds[bet.key]) || 0;
                    return sum + Math.floor(betData.stake * actualOdds);
                }, 0);
                
                const profit = totalReturn - totalInvested;
                
                const current = bankrollCurrent === '' ? 0 : parseInt(bankrollCurrent);
                const newBankroll = current + profit;
                setBankrollCurrent(newBankroll);
                
                const resultRecord = {
                    id: Date.now(),
                    date: raceMeta.date,
                    place: raceMeta.place,
                    raceNum: raceMeta.raceNum,
                    note: raceMeta.note,
                    result: { first: parseInt(raceResult.first), second: parseInt(raceResult.second), third: parseInt(raceResult.third) },
                    totalBets: betList.length,
                    winCount: winCount,
                    totalInvested: totalInvested,
                    totalReturn: totalReturn,
                    profit: profit,
                    bets: betList.map(bet => {
                        const betData = calculatedData.find(row => row.key === bet.key);
                        const isWin = results.find(r => r.key === bet.key)?.isWin || false;
                        // Á¢∫ÂÆö„Ç™„ÉÉ„Ç∫„Çí‰øùÂ≠òÔºàÁöÑ‰∏≠ÊôÇ„ÅÆ„ÅøÔºâ
                        const finalOddValue = isWin ? (parseFloat(finalOdds[bet.key]) || 0) : (betData?.odds || 0);

                        return {
                            type: bet.type,
                            combination: bet.label,
                            odds: finalOddValue,
                            stake: betData?.stake || 0,
                            isWin: isWin
                        };
                    })
                };
                
                const updatedResults = [...resultHistory, resultRecord];
                setResultHistory(updatedResults);
                localStorage.setItem('jra_odds_results', JSON.stringify(updatedResults));
                
                // ÁöÑ‰∏≠„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÅÆ„Åø„ÄÅÊúÄÂæå„Å´ÁµêÊûú„Çµ„Éû„É™„Éº„ÇíÂá∫„ÅôÔºàÁöÑ‰∏≠„Å™„Åó„ÅÆÂ†¥Âêà„ÅØÊó¢„Å´Âá∫„Å¶„ÅÑ„ÇãÔºâ
                if (winCount > 0) {
                    const resultMessage = `ÁöÑ‰∏≠: ${winCount}ÁÇπ / ${betList.length}ÁÇπ
ÊäïË≥áÈ°ç: ${totalInvested.toLocaleString()}ÂÜÜ
ÊâïÊàª: ${totalReturn.toLocaleString()}ÂÜÜ
ÂèéÊîØ: ${profit >= 0 ? '+' : ''}${profit.toLocaleString()}ÂÜÜ

üí∞ Ë≥áÈáëÊõ¥Êñ∞: ${current.toLocaleString()}ÂÜÜ ‚Üí ${newBankroll.toLocaleString()}ÂÜÜ`;
                    
                    showConfirm(
                        resultMessage,
                        () => {
                            setShowResultInput(false);
                            setRaceResult({ first: '', second: '', third: '' });
                            setShowOddsConfirm(false);
                        }
                    );
                } else {
                    // ÁöÑ‰∏≠„Å™„Åó„ÅÆÂ†¥Âêà„ÅØÊó¢„Å´„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅåÂá∫„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„É™„Çª„ÉÉ„Éà„Å†„ÅëË°å„ÅÜ
                    setShowResultInput(false);
                    setRaceResult({ first: '', second: '', third: '' });
                    setShowOddsConfirm(false);
                }
            };

            const handleFinalOddsSubmit = () => {
                if (!tempRaceResultData) return;
                finalizeBatch(tempRaceResultData.results, tempRaceResultData.totalInvested, finalOddsMap);
            };

            const calculatedData = useMemo(() => {
                if (betList.length === 0) return [];
                
                // ‰øÆÊ≠£: totalBudget„ÅåÁ©∫ÊñáÂ≠ó„ÅÆÂ†¥Âêà„ÅØ0„Å®„Åó„Å¶Êâ±„ÅÜ
                const budget = totalBudget === '' ? 0 : parseInt(totalBudget);
                
                const results = betList.map(c => ({ ...c, odds: oddsData[c.key] || 0 }));
                const validBets = results.filter(r => {
                    if (r.type === 'wide') {
                        const wideOdds = oddsData[r.key];
                        return wideOdds && typeof wideOdds === 'object' && (wideOdds.min > 0 || wideOdds.max > 0);
                    }
                    return r.odds > 0;
                });
                
                if (validBets.length === 0) {
                    return results.map(r => ({ ...r, stake: 0, return: 0, profit: -budget }));
                }

                if (allocationMode === 'flat') {
                    const stakePerBet = Math.floor((budget / results.length) / 100) * 100;
                    const betsWithStakes = results.map(r => {
                        const customStake = customStakes[r.key];
                        // ‰øÆÊ≠£: customStake„ÅåÁ©∫ÊñáÂ≠ó„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÊé°Áî®
                        const actualStake = (customStake !== undefined && customStake !== '') ? customStake : stakePerBet;
                        return { ...r, stake: actualStake };
                    });
                    
                    const actualTotal = betsWithStakes.reduce((sum, item) => sum + item.stake, 0);
                    return betsWithStakes.map(r => ({
                        ...r,
                        return: Math.floor(r.stake * r.odds),
                        profit: Math.floor(r.stake * r.odds) - actualTotal
                    }));
                } else {
                    const sumInverseOdds = validBets.reduce((acc, curr) => {
                        if (curr.type === 'wide') {
                            const wideOdds = oddsData[curr.key];
                            const avgOdds = ((wideOdds.min || 0) + (wideOdds.max || 0)) / 2;
                            return acc + (avgOdds > 0 ? 1 / avgOdds : 0);
                        }
                        return acc + (1 / curr.odds);
                    }, 0);
                    
                    const calculatedBets = results.map(r => {
                        if (r.type === 'wide') {
                            const wideOdds = oddsData[r.key];
                            if (!wideOdds || typeof wideOdds !== 'object') {
                                return { ...r, stake: 0, return: 0, profit: 0 };
                            }
                            const avgOdds = ((wideOdds.min || 0) + (wideOdds.max || 0)) / 2;
                            if (avgOdds <= 0) return { ...r, stake: 0, return: 0, profit: 0 };
                            let rawStake = (budget / sumInverseOdds) / avgOdds;
                            let stake = Math.round(rawStake / 100) * 100;
                            if (stake < 100) stake = 100;
                            return { ...r, stake };
                        } else {
                            if (r.odds <= 0) return { ...r, stake: 0, return: 0, profit: 0 };
                            let rawStake = (budget / sumInverseOdds) / r.odds;
                            let stake = Math.round(rawStake / 100) * 100;
                            if (stake < 100) stake = 100;
                            return { ...r, stake };
                        }
                    });

                    let currentTotal = calculatedBets.reduce((sum, item) => sum + item.stake, 0);
                    const finalBets = calculatedBets.map(r => {
                        const customStake = customStakes[r.key];
                        // ‰øÆÊ≠£: customStake„ÅåÁ©∫ÊñáÂ≠ó„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÊé°Áî®
                        const actualStake = (customStake !== undefined && customStake !== '') ? customStake : r.stake;
                        return { ...r, stake: actualStake };
                    });
                    const actualTotal = finalBets.reduce((sum, item) => sum + item.stake, 0);
                    return finalBets.map(r => ({
                        ...r,
                        return: Math.floor(r.stake * (r.type === 'wide' ? ((oddsData[r.key]?.min || 0) + (oddsData[r.key]?.max || 0)) / 2 : r.odds)),
                        profit: Math.floor(r.stake * (r.type === 'wide' ? ((oddsData[r.key]?.min || 0) + (oddsData[r.key]?.max || 0)) / 2 : r.odds)) - actualTotal
                    }));
                }
            }, [betList, oddsData, totalBudget, allocationMode, customStakes]);

            const stats = useMemo(() => {
                const totalStake = calculatedData.reduce((acc, curr) => acc + curr.stake, 0);
                const numerator = calculatedData.reduce((sum, item) => sum + (item.stake * item.return), 0);
                const realAverageOdds = totalStake > 0 ? (numerator / (totalStake * totalStake)).toFixed(2) : '---';
                
                let strategy = { zone: 'unknown', color: 'gray', message: '', emoji: '' };
                const oddsValue = parseFloat(realAverageOdds);
                
                if (!isNaN(oddsValue)) {
                    if (oddsValue < 1.5) {
                        strategy = { zone: 'danger', color: 'red', bgColor: 'bg-red-50', borderColor: 'border-red-300', textColor: 'text-red-800', emoji: '‚ö†Ô∏è', message: 'Âç±Èô∫ÔºöÂÆâ„Åô„Åé„Åæ„Åô„ÄÇË¶ãÈÄÅ„Çã„ÅãÁÇπÊï∞„ÇíÁµû„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' };
                    } else if (oddsValue < 3.0) {
                        strategy = { zone: 'optimal', color: 'emerald', bgColor: 'bg-emerald-50', borderColor: 'border-emerald-300', textColor: 'text-emerald-800', emoji: 'üî•', message: 'Êé®Â•®Ôºö„Éê„É©„É≥„ÇπÊúÄÈÅ©„ÄÇÂäπÁéá„Çà„ÅèË≥áÁî£„ÇíÂ¢ó„ÇÑ„Åõ„Çã„É©„Ç§„É≥„Åß„Åô„ÄÇ' };
                    } else {
                        strategy = { zone: 'aggressive', color: 'orange', bgColor: 'bg-orange-50', borderColor: 'border-orange-300', textColor: 'text-orange-800', emoji: '‚ö°', message: 'ÊîªÊíÉÔºöÁ©¥Áãô„ÅÑÂ∞ÇÁî®„ÄÇÈÄ£Êïó„É™„Çπ„ÇØ„ÅåÈ´ò„ÅÑÈ†òÂüü„Åß„Åô„ÄÇ' };
                    }
                }
                return { totalStake, realAverageOdds, count: betList.length, strategy };
            }, [calculatedData, betList]);

            // Bankroll Status Calculation
            const bankrollStatus = useMemo(() => {
                const start = bankrollStart === '' ? 0 : parseInt(bankrollStart);
                const goal = bankrollGoal === '' ? 0 : parseInt(bankrollGoal);
                const current = bankrollCurrent === '' ? 0 : parseInt(bankrollCurrent);

                const targetAmount = start + goal;
                const profit = current - start;
                const profitPercentage = start > 0 ? ((profit / start) * 100).toFixed(1) : 0;
                const progressPercentage = goal > 0 ? Math.min(100, Math.max(0, (profit / goal) * 100)) : 0;
                
                let status = { type: 'normal', color: 'emerald', bgColor: 'bg-emerald-500', borderColor: 'border-emerald-400', textColor: 'text-emerald-800', emoji: 'üü¢', message: '' };
                
                if (current >= targetAmount) {
                    status = { type: 'goal', color: 'yellow', bgColor: 'bg-gradient-to-r from-yellow-400 to-yellow-500', borderColor: 'border-yellow-400', textColor: 'text-yellow-900', emoji: 'üéâ', message: 'ÁõÆÊ®ôÈÅîÊàêÔºÅ Á¥†Êô¥„Çâ„Åó„ÅÑÊàêÊûú„Åß„Åô„ÄÇ‰ªäÊó•„ÅØ„Åì„Åì„Åß„ÄéÂãù„Å°ÈÄÉ„Åí„Äè„Åó„Åæ„Åõ„Çì„ÅãÔºü' };
                } else if (current <= start * 0.5) {
                    status = { type: 'danger', color: 'red', bgColor: 'bg-red-500', borderColor: 'border-red-400', textColor: 'text-red-900', emoji: '‚ö†Ô∏è', message: 'Ë≠¶ÂëäÔºöË≥áÈáë„ÅÆ50%„ÇíÂ§±„ÅÑ„Åæ„Åó„Åü„ÄÇ‰∏ÄÂ∫¶‰ºëÊÜ©„Åó„Å¶ÂÜ∑Èùô„Å´„Å™„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ' };
                } else {
                    status.message = `ÁèæÂú®ÂèéÊîØ: ${profit >= 0 ? '+' : ''}${profit.toLocaleString()}ÂÜÜ„ÄÇÂÜ∑Èùô„Å´ÁõÆÊ®ô„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`;
                }
                
                return { targetAmount, profit, profitPercentage, progressPercentage, status };
            }, [bankrollStart, bankrollGoal, bankrollCurrent]);

            // Render Components
            const renderHorseButton = (num, isSelected, colorClass, onClick) => (
                <button key={num} onClick={onClick} className={`h-12 sm:h-9 w-full rounded border text-lg sm:text-sm font-bold transition-all active:scale-95 ${isSelected ? `${colorClass} text-white shadow-md ring-1 ring-opacity-50` : "bg-white border-gray-300 text-gray-600 hover:bg-gray-50"}`}>{num}</button>
            );

            const getRowLabel = (index, type) => {
                if (type === 'sanrenpuku' || type === 'umaren' || type === 'wide') return `${index}È†≠ÁõÆ`;
                return `${index}ÁùÄ`;
            };

            const getTypeName = (type) => {
                const types = { sanrenpuku: '3ÈÄ£Ë§á', sanrentan: '3ÈÄ£Âçò', umaren: 'È¶¨ÈÄ£', umatan: 'È¶¨Âçò', wide: '„ÉØ„Ç§„Éâ', tansho: 'ÂçòÂãù', fukusho: 'Ë§áÂãù' };
                return types[type] || type;
            };

            const isSingleHorseBet = betType === 'tansho' || betType === 'fukusho';

            const formatDate = (dateStr) => {
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()}`;
            };

            // MAIN RENDER
            return (
                <div className="min-h-screen bg-gray-100 font-sans pb-20">
                    {/* ‚òÖËøΩÂä†: Á¢∫ÂÆö„Ç™„ÉÉ„Ç∫ÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ */}
                    {showOddsConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all animate-slide-in">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center"><Icons.DollarSign size={24} className="text-emerald-600" /></div>
                                    <h3 className="text-lg font-bold text-gray-800">ÁöÑ‰∏≠ÔºÅÁ¢∫ÂÆö„Ç™„ÉÉ„Ç∫ÂÖ•Âäõ</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-4">ÁöÑ‰∏≠„Åó„ÅüË≤∑„ÅÑÁõÆ„ÅÆ<strong>Á¢∫ÂÆö„Ç™„ÉÉ„Ç∫</strong>„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br/>ÔºàÂàùÊúüÂÄ§„ÅØ‰∫àÊÉ≥ÊôÇ„ÅÆ„Ç™„ÉÉ„Ç∫„Åß„ÅôÔºâ</p>
                                
                                <div className="max-h-60 overflow-y-auto mb-4 space-y-3 pr-1">
                                    {currentWinningBets.map(bet => (
                                        <div key={bet.key} className="flex items-center justify-between bg-gray-50 p-2 rounded border">
                                            <div className="flex flex-col">
                                                <span className="text-xs text-gray-500 font-bold">{getTypeName(bet.type)}</span>
                                                <span className="font-mono font-bold text-lg text-gray-700">{bet.label}</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-gray-500">ÂÄçÁéá:</span>
                                                <input 
                                                    type="number" 
                                                    step="0.1" 
                                                    value={finalOddsMap[bet.key] || ''}
                                                    onChange={(e) => setFinalOddsMap(prev => ({ ...prev, [bet.key]: e.target.value }))}
                                                    className="w-20 border border-emerald-300 rounded px-2 py-1 text-right font-bold text-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                                                />
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setShowOddsConfirm(false)} className="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                                    <button onClick={handleFinalOddsSubmit} className="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition-colors">ÁµêÊûú„ÇíÁ¢∫ÂÆö</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {confirmModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all animate-slide-in">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center"><Icons.Info size={24} className="text-yellow-600" /></div>
                                    <h3 className="text-lg font-bold text-gray-800">Á¢∫Ë™ç</h3>
                                </div>
                                <p className="text-gray-600 mb-6 leading-relaxed">{confirmModal.message}</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setConfirmModal(null)} className="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                                    <button onClick={handleConfirm} className="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition-colors">OK</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {toast && (
                        <div className={`fixed top-20 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl transform transition-all duration-300 ${toast.type === 'success' ? 'bg-emerald-600' : 'bg-red-500'} text-white font-bold flex items-center gap-3 animate-slide-in`}>
                            {toast.type === 'success' ? <Icons.CheckSquare size={24} /> : <Icons.X size={24} />}
                            <span>{toast.message}</span>
                        </div>
                    )}
                    
                    <header className="bg-emerald-700 text-white p-4 sticky top-0 z-30 shadow-md">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2"><Icons.Calculator size={20} /> ODDS MASTER</h1>
                            <div className="flex gap-2">
                                <button onClick={() => setCurrentView('courseData')} className={`text-xs px-2 sm:px-3 py-1 rounded flex items-center gap-1 border border-emerald-600 ${currentView === 'courseData' ? 'bg-emerald-900' : 'bg-emerald-800 hover:bg-emerald-600'}`}><Icons.BookOpen size={14} /> „Ç≥„Éº„Çπ</button>
                                <button onClick={() => setCurrentView('stats')} className={`text-xs px-2 sm:px-3 py-1 rounded flex items-center gap-1 border border-emerald-600 ${currentView === 'stats' ? 'bg-emerald-900' : 'bg-emerald-800 hover:bg-emerald-600'}`}><Icons.BarChart size={14} /> Áµ±Ë®à</button>
                                <button onClick={() => setCurrentView('history')} className={`text-xs px-2 sm:px-3 py-1 rounded flex items-center gap-1 border border-emerald-600 ${currentView === 'history' ? 'bg-emerald-900' : 'bg-emerald-800 hover:bg-emerald-600'}`}><Icons.History size={14} /> Â±•Ê≠¥</button>
                                {currentView === 'calculator' && <button onClick={clearAll} className="text-xs bg-emerald-800 px-2 sm:px-3 py-1 rounded hover:bg-emerald-600 border border-emerald-600">„É™„Çª„ÉÉ„Éà</button>}
                            </div>
                        </div>
                    </header>

                    {currentView === 'calculator' && (
                        <main className="max-w-3xl mx-auto p-3 sm:p-4 space-y-4 sm:space-y-6">
                            <section className="bg-white rounded-lg shadow overflow-hidden">
                                <button onClick={() => setShowBankroll(!showBankroll)} className="w-full p-3 flex items-center justify-between bg-gradient-to-r from-emerald-600 to-emerald-700 text-white hover:from-emerald-700 hover:to-emerald-800 transition-all">
                                    <div className="flex items-center gap-2"><Icons.TrendingUp size={20} /><span className="font-bold">Today's Bankroll</span><span className="text-xs bg-white/20 px-2 py-0.5 rounded">{bankrollStatus.profit >= 0 ? '+' : ''}{bankrollStatus.profit.toLocaleString()}ÂÜÜ</span></div>
                                    {showBankroll ? <Icons.ChevronUp size={20} /> : <Icons.ChevronDown size={20} />}
                                </button>

                                {showBankroll && (
                                    <div className="p-4 space-y-4">
                                        {/* Input Fields */}
                                        <div className="grid grid-cols-3 gap-3">
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 block mb-1">ÈñãÂßãË≥áÈáë</label>
                                                <div className="relative">
                                                    <input 
                                                        type="number" 
                                                        step="1000" 
                                                        value={bankrollStart === 0 ? '' : bankrollStart} 
                                                        onChange={(e) => setBankrollStart(e.target.value === '' ? '' : parseInt(e.target.value))} 
                                                        className="w-full border border-gray-300 rounded px-2 py-1.5 pr-8 text-sm text-right font-mono focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" 
                                                        placeholder="0" 
                                                    />
                                                    <span className="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none">ÂÜÜ</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 block mb-1">ÁõÆÊ®ôÂà©Áõä</label>
                                                <div className="relative">
                                                    <input 
                                                        type="number" 
                                                        step="1000" 
                                                        value={bankrollGoal === 0 ? '' : bankrollGoal} 
                                                        onChange={(e) => setBankrollGoal(e.target.value === '' ? '' : parseInt(e.target.value))} 
                                                        className="w-full border border-gray-300 rounded px-2 py-1.5 pr-8 text-sm text-right font-mono focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" 
                                                        placeholder="0" 
                                                            />
                                                            <span className="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none">ÂÜÜ</span>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-gray-500 block mb-1">ÁèæÂú®Ë≥áÈáë</label>
                                                        <div className="relative">
                                                            <input 
                                                                type="number" 
                                                                step="100" 
                                                                value={bankrollCurrent === 0 ? '' : bankrollCurrent} 
                                                                onChange={(e) => setBankrollCurrent(e.target.value === '' ? '' : parseInt(e.target.value))} 
                                                                className="w-full border border-gray-300 rounded px-2 py-1.5 pr-8 text-sm text-right font-mono focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" 
                                                                placeholder="0" 
                                                            />
                                                            <span className="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none">ÂÜÜ</span>
                                                        </div>
                                                    </div>
                                                </div>

                                        {/* Progress Bar */}
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-xs text-gray-600">
                                                <span>ÈñãÂßã: {(bankrollStart === '' ? 0 : bankrollStart).toLocaleString()}ÂÜÜ</span>
                                                <span className="font-bold text-emerald-700">ÁõÆÊ®ôÈáëÈ°ç: {bankrollStatus.targetAmount.toLocaleString()}ÂÜÜ</span>
                                            </div>
                                            <div className="relative h-8 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                                                <div 
                                                    className={`h-full transition-all duration-500 ${bankrollStatus.status.bgColor} flex items-center justify-end px-3`}
                                                    style={{ width: `${bankrollStatus.progressPercentage}%` }}
                                                >
                                                    {bankrollStatus.progressPercentage > 20 && (
                                                        <span className="text-xs font-bold text-white drop-shadow">
                                                            {bankrollStatus.progressPercentage.toFixed(0)}%
                                                        </span>
                                                    )}
                                                </div>
                                                {bankrollStatus.progressPercentage <= 20 && bankrollStatus.progressPercentage > 0 && (
                                                    <span className="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold text-gray-600">
                                                        {bankrollStatus.progressPercentage.toFixed(0)}%
                                                    </span>
                                                )}
                                            </div>
                                            <div className="flex justify-between text-xs">
                                                <span className={`font-bold ${bankrollStatus.profit >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                    ÁèæÂú®: {(bankrollCurrent === '' ? 0 : bankrollCurrent).toLocaleString()}ÂÜÜ ({bankrollStatus.profit >= 0 ? '+' : ''}{bankrollStatus.profitPercentage}%)
                                                </span>
                                            </div>
                                        </div>

                                        {/* Status Message */}
                                        <div className={`p-3 rounded-lg border-l-4 ${bankrollStatus.status.type === 'goal' ? 'bg-yellow-50 border-yellow-400' : bankrollStatus.status.type === 'danger' ? 'bg-red-50 border-red-400' : 'bg-emerald-50 border-emerald-400'}`}>
                                            <div className="flex items-start gap-2">
                                                <span className="text-xl">{bankrollStatus.status.emoji}</span>
                                                <p className={`text-sm font-bold ${bankrollStatus.status.textColor}`}>
                                                    {bankrollStatus.status.message}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {/* Action Buttons & History */}
                                        <div className="pt-2 border-t border-gray-100">
                                            <div className="flex gap-2 mb-4">
                                                <button
                                                    onClick={saveBankrollSession}
                                                    className="flex-1 bg-blue-600 text-white py-2 px-3 rounded font-bold text-xs hover:bg-blue-700 flex items-center justify-center gap-1"
                                                >
                                                    <Icons.Save size={14} />
                                                    Ë®òÈå≤„ÅÆ„Åø‰øùÂ≠ò
                                                </button>
                                                <button
                                                    onClick={resetBankrollSession}
                                                    className="flex-1 bg-emerald-600 text-white py-2 px-3 rounded font-bold text-xs hover:bg-emerald-700 flex items-center justify-center gap-1"
                                                >
                                                    <Icons.RefreshCw size={14} />
                                                    ‰øùÂ≠ò„Åó„Å¶Ê¨°„Å∏
                                                </button>
                                            </div>

                                            {bankrollHistory.length > 0 && (
                                                <div className="space-y-2">
                                                    <h4 className="text-xs font-bold text-gray-500 uppercase">ÈÅéÂéª„ÅÆË®òÈå≤</h4>
                                                    <div className="max-h-40 overflow-y-auto space-y-2 pr-1">
                                                        {bankrollHistory.map(record => (
                                                            <div key={record.id} className="bg-gray-50 p-2 rounded border border-gray-200 text-xs flex justify-between items-center">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-bold text-gray-700">{record.date}</span>
                                                                        {record.isGoal && <span className="bg-yellow-100 text-yellow-800 px-1 rounded text-[10px]">ÈÅîÊàê</span>}
                                                                    </div>
                                                                    <div className="text-gray-500 mt-0.5">
                                                                        {record.start.toLocaleString()} ‚Üí {record.end.toLocaleString()}
                                                                    </div>
                                                                </div>
                                                                <div className="text-right mr-2">
                                                                    <div className={`font-bold ${record.profit >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                                        {record.profit >= 0 ? '+' : ''}{record.profit.toLocaleString()}
                                                                    </div>
                                                                    <div className="text-[10px] text-gray-400">
                                                                        ({record.percent}%)
                                                                    </div>
                                                                </div>
                                                                <button 
                                                                    onClick={() => deleteBankrollRecord(record.id)}
                                                                    className="text-gray-400 hover:text-red-500 p-1"
                                                                >
                                                                    <Icons.Trash2 size={14} />
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </section>

                            <section className="bg-white rounded-lg shadow p-3">
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <div className="col-span-2 sm:col-span-1 relative">
                                        <label className="flex items-center gap-1 text-xs text-gray-500 font-bold mb-1"><Icons.Calendar size={12} /> Êó•‰ªò</label>
                                        <button type="button" onClick={() => setShowCalendar(!showCalendar)} className="w-full text-sm bg-white border-2 border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all hover:border-emerald-300 text-left flex items-center justify-between"><span>{raceMeta.date}</span><Icons.Calendar size={16} className="text-gray-400" /></button>
                                        {showCalendar && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setShowCalendar(false)}></div>
                                                <div className="absolute top-full left-0 mt-2 bg-white rounded-2xl shadow-2xl border border-gray-200 p-4 z-50 w-80">
                                                    <div className="flex items-center justify-between mb-4">
                                                        <button type="button" onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors"><Icons.ArrowLeft size={20} /></button>
                                                        <div className="font-bold text-gray-800">{calendarDate.getFullYear()}Âπ¥ {calendarDate.getMonth() + 1}Êúà</div>
                                                        <button type="button" onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors transform rotate-180"><Icons.ArrowLeft size={20} /></button>
                                                    </div>
                                                    <div className="grid grid-cols-7 gap-1 mb-2">{['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'].map(day => (<div key={day} className="text-center text-xs font-bold text-gray-500 py-2">{day}</div>))}</div>
                                                    <div className="grid grid-cols-7 gap-1">
                                                        {(() => {
                                                            const { daysInMonth, startingDayOfWeek } = getDaysInMonth(calendarDate);
                                                            const days = [];
                                                            for (let i = 0; i < startingDayOfWeek; i++) { days.push(<div key={`empty-${i}`} className="aspect-square"></div>); }
                                                            const selectedDate = new Date(raceMeta.date);
                                                            for (let day = 1; day <= daysInMonth; day++) {
                                                                const isSelected = selectedDate.getFullYear() === calendarDate.getFullYear() && selectedDate.getMonth() === calendarDate.getMonth() && selectedDate.getDate() === day;
                                                                const isToday = new Date().getFullYear() === calendarDate.getFullYear() && new Date().getMonth() === calendarDate.getMonth() && new Date().getDate() === day;
                                                                days.push(<button key={day} type="button" onClick={() => selectDate(day)} className={`aspect-square rounded-lg text-sm font-medium transition-all hover:bg-emerald-100 ${isSelected ? 'bg-emerald-600 text-white hover:bg-emerald-700' : isToday ? 'border-2 border-emerald-600 text-emerald-600' : 'text-gray-700'}`}>{day}</button>);
                                                            }
                                                            return days;
                                                        })()}
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                    <div><label className="flex items-center gap-1 text-xs text-gray-500 font-bold mb-1"><Icons.MapPin size={12} /> Â†¥ÊâÄ</label><select value={raceMeta.place} onChange={(e) => handleMetaChange('place', e.target.value)} className="w-full text-sm border-gray-300 rounded border p-1.5">{['Êú≠Âπå','ÂáΩÈ§®','Á¶èÂ≥∂','Êñ∞ÊΩü','Êù±‰∫¨','‰∏≠Â±±','‰∏≠‰∫¨','‰∫¨ÈÉΩ','Èò™Á•û','Â∞èÂÄâ'].map(p => (<option key={p} value={p}>{p}</option>))}</select></div>
                                    <div><label className="flex items-center gap-1 text-xs text-gray-500 font-bold mb-1"><Icons.Flag size={12} /> R</label><select value={raceMeta.raceNum} onChange={(e) => handleMetaChange('raceNum', parseInt(e.target.value))} className="w-full text-sm border-gray-300 rounded border p-1.5">{Array.from({length:12}, (_, i) => i + 1).map(n => (<option key={n} value={n}>{n}R</option>))}</select></div>
                                    <div className="col-span-2 sm:col-span-1"><label className="flex items-center gap-1 text-xs text-gray-500 font-bold mb-1"><Icons.FileText size={12} /> „É°„É¢</label><input type="text" placeholder="„É¨„Éº„ÇπÂêç„Å™„Å©" value={raceMeta.note} onChange={(e) => setRaceMeta(prev => ({ ...prev, note: e.target.value }))} className="w-full text-sm border-gray-300 rounded border p-1.5" /></div>
                                </div>
                            </section>

                            <section className="bg-white rounded-lg shadow overflow-hidden relative">
                                <div className="p-3 bg-gray-50 border-b flex justify-between items-center"><h2 className="font-bold text-gray-700 flex items-center gap-2"><Icons.Settings size={18}/> Ë≤∑„ÅÑÁõÆ‰ΩúÊàê</h2><button onClick={clearSelection} className="text-xs text-gray-500 hover:text-red-500 underline">ÈÅ∏Êäû„ÇØ„É™„Ç¢</button></div>
                                <div className="p-4 space-y-3 border-b border-gray-100">
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <div className="flex-1"><label className="block text-xs font-bold text-gray-500 mb-1">ÂºèÂà•</label><select className="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded p-2 focus:ring-emerald-500" value={betType} onChange={(e) => handleBetTypeChange(e.target.value)}><option value="tansho">ÂçòÂãù</option><option value="fukusho">Ë§áÂãù</option><option value="wide">„ÉØ„Ç§„Éâ</option><option value="umaren">È¶¨ÈÄ£</option><option value="umatan">È¶¨Âçò</option><option value="sanrenpuku">3ÈÄ£Ë§á</option><option value="sanrentan">3ÈÄ£Âçò</option></select></div>
                                        <div className="flex-1"><label className="block text-xs font-bold text-gray-500 mb-1">ÊñπÂºè</label><div className="flex bg-gray-200 rounded p-1">{!isSingleHorseBet && (<><button onClick={() => setVotingMode('nagashi')} className={`flex-1 flex items-center justify-center gap-1 text-xs py-1.5 rounded transition-all ${votingMode === 'nagashi' ? 'bg-white text-emerald-700 shadow font-bold' : 'text-gray-500'}`}><Icons.GitMerge size={14} className="rotate-90" /> ÊµÅ„Åó</button><button onClick={() => setVotingMode('formation')} className={`flex-1 flex items-center justify-center gap-1 text-xs py-1.5 rounded transition-all ${votingMode === 'formation' ? 'bg-white text-emerald-700 shadow font-bold' : 'text-gray-500'}`}><Icons.Layers size={14} /> „Éï„Ç©„Éº„É°</button></>)}<button onClick={() => setVotingMode('box')} className={`flex-1 flex items-center justify-center gap-1 text-xs py-1.5 rounded transition-all ${votingMode === 'box' ? 'bg-white text-emerald-700 shadow font-bold' : 'text-gray-500'}`}><Icons.CheckSquare size={14} /> {isSingleHorseBet ? 'ÈÄöÂ∏∏' : 'BOX'}</button></div></div>
                                    </div>
                                </div>
                                <div className="p-4">
                                    {votingMode === 'box' && (<><div className="mb-2 text-xs text-center text-gray-500">{isSingleHorseBet ? 'È¶¨„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ' : '„Éú„ÉÉ„ÇØ„ÇπË≤∑„ÅÑ„Åô„ÇãÈ¶¨„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'}</div><div className="grid grid-cols-6 sm:grid-cols-9 gap-1.5">{Array.from({ length: horseCount }, (_, i) => i + 1).map(num => { const isSelected = boxHorses.includes(num); return renderHorseButton(num, isSelected, 'bg-emerald-600 border-emerald-700', () => toggleBoxHorse(num)); })}</div></>)}
                                    {votingMode === 'nagashi' && !isSingleHorseBet && (<><div className="mb-2 text-xs text-center text-gray-500">Ëª∏(„Éî„É≥„ÇØ)1È†≠ ‚Üí Áõ∏Êâã(Èùí)„ÇíÈÅ∏Êäû</div><div className="grid grid-cols-6 sm:grid-cols-9 gap-1.5">{Array.from({ length: horseCount }, (_, i) => i + 1).map(num => { const isAxis = axisHorse === num; const isOpp = opponentHorses.includes(num); const color = isAxis ? 'bg-pink-500 border-pink-600' : 'bg-blue-500 border-blue-600'; return renderHorseButton(num, isAxis || isOpp, color, () => handleNagashiClick(num)); })}</div></>)}
                                    {votingMode === 'formation' && !isSingleHorseBet && (
                                        <div className="space-y-4">
                                            <div><div className="flex items-center gap-2 mb-1"><span className="bg-pink-100 text-pink-800 text-xs font-bold px-2 py-0.5 rounded border border-pink-200">{getRowLabel(1, betType)}</span></div><div className="grid grid-cols-9 gap-1">{Array.from({ length: horseCount }, (_, i) => i + 1).map(num => renderHorseButton(num, formation.first.includes(num), 'bg-pink-500 border-pink-600', () => toggleFormationHorse('first', num)))}</div></div>
                                            <div><div className="flex items-center gap-2 mb-1"><span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded border border-blue-200">{getRowLabel(2, betType)}</span></div><div className="grid grid-cols-9 gap-1">{Array.from({ length: horseCount }, (_, i) => i + 1).map(num => renderHorseButton(num, formation.second.includes(num), 'bg-blue-500 border-blue-600', () => toggleFormationHorse('second', num)))}</div></div>
                                            {(betType === 'sanrenpuku' || betType === 'sanrentan') && (<div><div className="flex items-center gap-2 mb-1"><span className="bg-green-100 text-green-800 text-xs font-bold px-2 py-0.5 rounded border border-green-200">{getRowLabel(3, betType)}</span></div><div className="grid grid-cols-9 gap-1">{Array.from({ length: horseCount }, (_, i) => i + 1).map(num => renderHorseButton(num, formation.third.includes(num), 'bg-green-500 border-green-600', () => toggleFormationHorse('third', num)))}</div></div>)}
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 bg-gray-50 border-t flex flex-col items-center">
                                    <div className="text-sm font-bold text-gray-700 mb-2">ÁèæÂú®„ÅÆÈÅ∏Êäû: <span className="text-emerald-600 text-lg">{previewCombinations.length}</span> ÁÇπ</div>
                                    <button onClick={addBetsToList} disabled={previewCombinations.length === 0} className={`w-full sm:w-auto px-8 py-3 rounded-full font-bold flex items-center justify-center gap-2 shadow-lg transition-transform active:scale-95 ${previewCombinations.length > 0 ? 'bg-emerald-600 text-white hover:bg-emerald-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}><Icons.PlusCircle size={20} /> ‰∏ã„ÅÆ„É™„Çπ„Éà„Å´ËøΩÂä†</button>
                                </div>
                            </section>

                            {betList.length > 0 && (
                                <section className="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-400">
                                    <div className="mb-4 flex items-center gap-4 pb-3 border-b">
                                        <span className="text-xs font-bold text-gray-500 uppercase">ÂÖ•Âäõ„É¢„Éº„Éâ:</span>
                                        <div className="flex gap-3">
                                            <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="budgetMode" value="budget" checked={budgetInputMode === 'budget'} onChange={(e) => { setBudgetInputMode(e.target.value); setTargetError(null); }} className="w-4 h-4 text-emerald-600" /><span className="text-sm font-medium text-gray-700">‰∫àÁÆó„Åã„ÇâË®àÁÆó</span></label>
                                            <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="budgetMode" value="target" checked={budgetInputMode === 'target'} onChange={(e) => { setBudgetInputMode(e.target.value); setAllocationMode('profit'); setTargetError(null); }} className="w-4 h-4 text-blue-600" /><span className="text-sm font-medium text-gray-700">ÁõÆÊ®ôÂà©Áõä„Åã„ÇâË®àÁÆó</span></label>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            {budgetInputMode === 'budget' ? (
                                                <>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Á∑è‰∫àÁÆó</label>
                                                    <div className="flex items-center gap-2">
                                                        {/* ‰øÆÊ≠£: Á©∫ÊñáÂ≠ó„ÇíË®±ÂÆπ */}
                                                        <input 
                                                            type="number" 
                                                            value={totalBudget} 
                                                            onChange={(e) => setTotalBudget(e.target.value === '' ? '' : parseInt(e.target.value))} 
                                                            className="w-full border border-gray-300 rounded p-2 text-right font-mono text-lg focus:ring-2 focus:ring-emerald-500 outline-none" 
                                                            step="100" 
                                                            inputMode="numeric" 
                                                            placeholder="0"
                                                        />
                                                        <span className="text-gray-500 text-sm">ÂÜÜ</span>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <label className="block text-xs font-bold text-blue-600 uppercase mb-1">ÁõÆÊ®ôÂà©Áõä</label>
                                                    <div className="flex flex-col gap-2">
                                                        <div className="flex items-center gap-2">
                                                            {/* ‰øÆÊ≠£: Á©∫ÊñáÂ≠ó„ÇíË®±ÂÆπ */}
                                                            <input 
                                                                type="number" 
                                                                value={targetProfit} 
                                                                onChange={(e) => setTargetProfit(e.target.value === '' ? '' : parseInt(e.target.value))} 
                                                                className="w-full border border-blue-300 rounded p-2 text-right font-mono text-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                                                                step="100" 
                                                                inputMode="numeric" 
                                                                placeholder="0"
                                                            />
                                                            <span className="text-gray-500 text-sm">ÂÜÜ</span>
                                                        </div>
                                                        <button onClick={calculateBudgetFromTarget} className="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"><Icons.Calculator size={16} /> ÂøÖË¶Å‰∫àÁÆó„ÇíË®àÁÆó</button>
                                                        {targetError && (<div className="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded text-xs">{targetError}</div>)}
                                                        {!targetError && budgetInputMode === 'target' && (
                                                            <div className="bg-blue-50 border border-blue-200 text-blue-700 px-3 py-2 rounded text-xs">
                                                                <strong>ÂøÖË¶Å‰∫àÁÆó:</strong> {totalBudget.toLocaleString()}ÂÜÜ
                                                            </div>
                                                        )}
                                                    </div>
                                                </>
                                            )}
                                        </div>

                                        <div className="flex flex-col justify-between">
                                            <div className="flex justify-between text-sm mb-1"><span className="text-gray-600">Ë≤∑„ÅÑÁõÆÂêàË®à:</span><span className="font-bold">{stats.count} ÁÇπ</span></div>
                                            <div className="flex justify-between text-sm mb-1"><span className="text-gray-600">ÊäïË≥áÁ∑èÈ°ç:</span><span className={`font-bold ${stats.totalStake > (totalBudget === '' ? 0 : parseInt(totalBudget)) ? 'text-red-500' : 'text-emerald-600'}`}>{stats.totalStake.toLocaleString()} ÂÜÜ</span></div>
                                            <div className="flex justify-between text-sm"><span className="text-gray-600">ÂÆüË≥™Âπ≥Âùá„Ç™„ÉÉ„Ç∫:</span><span className="font-bold bg-gray-100 px-2 rounded">{stats.realAverageOdds} ÂÄç</span></div>
                                        </div>
                                    </div>

                                    {stats.strategy && stats.strategy.zone !== 'unknown' && (
                                        <div className={`mt-3 p-3 rounded-lg border-l-4 ${stats.strategy.bgColor} ${stats.strategy.borderColor}`}><div className="flex items-start gap-2"><span className="text-lg">{stats.strategy.emoji}</span><div className="flex-1"><p className={`text-sm font-bold ${stats.strategy.textColor}`}>{stats.strategy.message}</p></div></div></div>
                                    )}

                                    <div className="mt-4 flex gap-2">
                                        <button onClick={() => { setAllocationMode('profit'); setCustomStakes({}); }} className={`flex-1 text-xs py-2 rounded border ${allocationMode === 'profit' ? 'bg-emerald-100 border-emerald-500 text-emerald-800 font-bold' : 'bg-white text-gray-600'}`}>ÊâïÊàªÂùáÁ≠â (Âà©ÁõäÁ¢∫‰øù){budgetInputMode === 'target' && <span className="block text-[10px] text-emerald-600 mt-0.5">ÁõÆÊ®ôÂà©Áõä„É¢„Éº„Éâ‰ΩøÁî®‰∏≠</span>}</button>
                                        <button onClick={() => { if (budgetInputMode !== 'target') { setAllocationMode('flat'); setCustomStakes({}); } }} disabled={budgetInputMode === 'target'} className={`flex-1 text-xs py-2 rounded border ${budgetInputMode === 'target' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : allocationMode === 'flat' ? 'bg-emerald-100 border-emerald-500 text-emerald-800 font-bold' : 'bg-white text-gray-600'}`}>Ë≥áÈáëÂùáÁ≠â (‰∏ÄÂæã){budgetInputMode === 'target' && <span className="block text-[10px] text-gray-400 mt-0.5">Âà©Áõä„É¢„Éº„Éâ„Åß„ÅØÁÑ°Âäπ</span>}</button>
                                    </div>
                                </section>
                            )}

                            {betList.length > 0 ? (
                                <section id="bet-list-section" className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="bg-gray-50 p-3 border-b flex justify-between items-center">
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                            <Icons.Save size={18} /> 
                                            Ë≤∑„ÅÑÁõÆ„É™„Çπ„Éà ({betList.length}ÁÇπ)
                                        </h3>
                                    </div>
                                    
                                    <div className="overflow-x-auto max-h-[600px]">
                                        <table className="w-full text-sm text-left relative">
                                            <thead className="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10 shadow-sm">
                                                <tr>
                                                    <th className="p-1.5 sm:p-3">ÂºèÂà•/ÁµÑÂêà„Åõ</th>
                                                    <th className="p-1.5 sm:p-3 text-center">„Ç™„ÉÉ„Ç∫</th>
                                                    <th className="p-1.5 sm:p-3 text-right">ÊäïË≥áÈ°ç</th>
                                                    <th className="p-1.5 sm:p-3 text-right hidden sm:table-cell">‰∫àÊÉ≥ÊâïÊàª</th>
                                                    <th className="p-1.5 sm:p-3 w-8 sm:w-10"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {betList.map((bet) => {
                                                    const isWide = bet.type === 'wide';
                                                    const wideOdds = isWide ? oddsData[bet.key] : null;
                                                    const hasWideOdds = wideOdds && typeof wideOdds === 'object';
                                                    
                                                    const betData = calculatedData.find(row => row.key === bet.key);
                                                    
                                                    return (
                                                        <React.Fragment key={bet.key}>
                                                            <tr className="hover:bg-emerald-50 transition-colors">
                                                                <td className="p-1.5 sm:p-3" rowSpan={isWide && hasWideOdds ? 2 : 1}>
                                                                    <div className="flex flex-col">
                                                                        <span className="text-[9px] sm:text-[10px] text-gray-400 font-bold uppercase tracking-wider">{getTypeName(bet.type)}</span>
                                                                        <span className="font-mono font-bold text-gray-700 text-sm sm:text-lg">{bet.label}</span>
                                                                    </div>
                                                                </td>
                                                                {isWide ? (
                                                                    <>
                                                                        <td className="p-1.5 sm:p-3">
                                                                            <div className="flex flex-col sm:flex-row items-center gap-1">
                                                                                <span className="text-[10px] sm:text-xs text-gray-500 whitespace-nowrap">‰∏ãÈôê</span>
                                                                                <input type="number" step="0.1" placeholder="0.0" value={hasWideOdds ? wideOdds.min || '' : ''} onChange={(e) => handleOddsChange(bet.key, e.target.value, 'min')} className="w-16 border border-gray-300 rounded px-1 py-1 text-base sm:text-sm text-right focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" inputMode="decimal" />
                                                                            </div>
                                                                        </td>
                                                                        <td className="p-1.5 sm:p-3 text-right font-mono" rowSpan={2}>
                                                                            {betData?.stake >= 0 ? (
                                                                                <div className="flex flex-col items-end gap-1">
                                                                                    {/* ‰øÆÊ≠£: Á©∫ÊñáÂ≠ó„ÇíË®±ÂÆπ */}
                                                                                    <input 
                                                                                        type="number" 
                                                                                        step="100" 
                                                                                        value={customStakes[bet.key] !== undefined ? customStakes[bet.key] : (betData.stake || '')} 
                                                                                        onChange={(e) => handleStakeChange(bet.key, e.target.value)} 
                                                                                        className="w-20 sm:w-24 bg-emerald-100 text-emerald-800 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-xs sm:text-sm text-right border border-emerald-300 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none font-mono" 
                                                                                        inputMode="numeric" 
                                                                                        placeholder="0"
                                                                                    />
                                                                                    <div className="sm:hidden flex flex-col items-end text-[10px]"><span className="font-bold">{betData.return.toLocaleString()}</span><span className={betData.profit >= 0 ? 'text-emerald-600' : 'text-red-500'}>{betData.profit >= 0 ? '+' : ''}{betData.profit.toLocaleString()}</span></div>
                                                                                </div>
                                                                            ) : '-'}
                                                                        </td>
                                                                        <td className="p-1.5 sm:p-3 text-right hidden sm:table-cell">{betData?.stake > 0 && wideOdds.min ? (<div className="flex flex-col items-end"><span className="font-bold">{Math.floor(betData.stake * wideOdds.min).toLocaleString()}</span><span className={`text-xs ${Math.floor(betData.stake * wideOdds.min) - stats.totalStake >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>{Math.floor(betData.stake * wideOdds.min) - stats.totalStake >= 0 ? '+' : ''}{(Math.floor(betData.stake * wideOdds.min) - stats.totalStake).toLocaleString()}</span></div>) : '-'}</td>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <td className="p-1.5 sm:p-3 text-center"><input type="number" step="0.1" placeholder="0.0" value={oddsData[bet.key] || ''} onChange={(e) => handleOddsChange(bet.key, e.target.value)} className="w-16 border border-gray-300 rounded px-1 py-1 text-base sm:text-sm text-right focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" inputMode="decimal" /></td>
                                                                        <td className="p-1.5 sm:p-3 text-right font-mono">
                                                                            {betData?.stake >= 0 ? (
                                                                                <div className="flex flex-col items-end gap-1">
                                                                                    {/* ‰øÆÊ≠£: Á©∫ÊñáÂ≠ó„ÇíË®±ÂÆπ */}
                                                                                    <input 
                                                                                        type="number" 
                                                                                        step="100" 
                                                                                        value={customStakes[bet.key] !== undefined ? customStakes[bet.key] : (betData.stake || '')} 
                                                                                        onChange={(e) => handleStakeChange(bet.key, e.target.value)} 
                                                                                        className="w-20 sm:w-24 bg-emerald-100 text-emerald-800 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-xs sm:text-sm text-right border border-emerald-300 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none font-mono" 
                                                                                        inputMode="numeric" 
                                                                                        placeholder="0"
                                                                                    />
                                                                                    <div className="sm:hidden flex flex-col items-end text-[10px]"><span className="font-bold">{betData.return.toLocaleString()}</span><span className={betData.profit >= 0 ? 'text-emerald-600' : 'text-red-500'}>{betData.profit >= 0 ? '+' : ''}{betData.profit.toLocaleString()}</span></div>
                                                                                </div>
                                                                            ) : '-'}
                                                                        </td>
                                                                        <td className="p-1.5 sm:p-3 text-right hidden sm:table-cell">{betData?.stake > 0 ? (<div className="flex flex-col items-end"><span className="font-bold">{betData.return.toLocaleString()}</span><span className={`text-xs ${betData.profit >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>{betData.profit >= 0 ? '+' : ''}{betData.profit.toLocaleString()}</span></div>) : '-'}</td>
                                                                    </>
                                                                )}
                                                                <td className="p-1.5 sm:p-3 text-right" rowSpan={isWide && hasWideOdds ? 2 : 1}><button onClick={() => removeBet(bet.key)} className="text-gray-400 hover:text-red-500 transition-colors"><Icons.Trash2 size={14} className="sm:hidden" /><Icons.Trash2 size={16} className="hidden sm:block" /></button></td>
                                                            </tr>
                                                            {isWide && hasWideOdds && (
                                                                <tr className="hover:bg-emerald-50 transition-colors border-l-4 border-l-blue-200">
                                                                    <td className="p-1.5 sm:p-3"><div className="flex flex-col sm:flex-row items-center gap-1"><span className="text-[10px] sm:text-xs text-gray-500 whitespace-nowrap">‰∏äÈôê</span><input type="number" step="0.1" placeholder="0.0" value={wideOdds.max || ''} onChange={(e) => handleOddsChange(bet.key, e.target.value, 'max')} className="w-16 border border-gray-300 rounded px-1 py-1 text-base sm:text-sm text-right focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" inputMode="decimal" /></div></td>
                                                                    <td className="p-1.5 sm:p-3 text-right hidden sm:table-cell">{betData?.stake > 0 && wideOdds.max ? (<div className="flex flex-col items-end"><span className="font-bold">{Math.floor(betData.stake * wideOdds.max).toLocaleString()}</span><span className={`text-xs ${Math.floor(betData.stake * wideOdds.max) - stats.totalStake >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>{Math.floor(betData.stake * wideOdds.max) - stats.totalStake >= 0 ? '+' : ''}{(Math.floor(betData.stake * wideOdds.max) - stats.totalStake).toLocaleString()}</span></div>) : '-'}</td>
                                                                    <td className="p-1.5 sm:p-3 text-right sm:hidden">{betData?.stake > 0 && wideOdds.max ? (<div className="flex flex-col items-end text-[10px]"><span className="font-bold">{Math.floor(betData.stake * wideOdds.max).toLocaleString()}</span><span className={Math.floor(betData.stake * wideOdds.max) - stats.totalStake >= 0 ? 'text-emerald-600' : 'text-red-500'}>{Math.floor(betData.stake * wideOdds.max) - stats.totalStake >= 0 ? '+' : ''}{(Math.floor(betData.stake * wideOdds.max) - stats.totalStake).toLocaleString()}</span></div>) : '-'}</td>
                                                                </tr>
                                                            )}
                                                        </React.Fragment>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="p-4 bg-gray-50 border-t">
                                        <div className="flex gap-3 mb-4">
                                            <button 
                                                onClick={saveToHistory}
                                                className="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700 flex items-center justify-center gap-2"
                                            >
                                                <Icons.Save size={20} />
                                                Â±•Ê≠¥„Å´‰øùÂ≠ò
                                            </button>
                                            <button 
                                                onClick={() => setShowResultInput(!showResultInput)} 
                                                className={`flex-1 font-bold py-3 rounded-lg shadow flex items-center justify-center gap-2 transition-colors ${
                                                    showResultInput 
                                                    ? 'bg-purple-600 text-white hover:bg-purple-700' 
                                                    : 'bg-white text-purple-600 border border-purple-200 hover:bg-purple-50'
                                                }`}
                                            >
                                                <Icons.Award size={20} /> 
                                                ÁöÑ‰∏≠Âà§ÂÆö
                                            </button>
                                        </div>
                                        
                                        {showResultInput && (
                                            <div className="p-4 bg-purple-50 rounded-lg border-2 border-purple-200 animate-slide-in">
                                                <h4 className="font-bold text-purple-900 mb-3 flex items-center gap-2"><Icons.Award size={16} /> „É¨„Éº„ÇπÁµêÊûú„ÇíÂÖ•Âäõ</h4>
                                                <div className="grid grid-cols-3 gap-3 mb-3">
                                                    <div><label className="text-xs text-purple-700 font-semibold block mb-1">1ÁùÄ</label><input type="number" min="1" max={horseCount} value={raceResult.first} onChange={(e) => setRaceResult(prev => ({ ...prev, first: e.target.value }))} className="w-full border border-purple-300 rounded px-2 py-2 text-center text-base focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none" placeholder="È¶¨Áï™" inputMode="numeric" /></div>
                                                    <div><label className="text-xs text-purple-700 font-semibold block mb-1">2ÁùÄ</label><input type="number" min="1" max={horseCount} value={raceResult.second} onChange={(e) => setRaceResult(prev => ({ ...prev, second: e.target.value }))} className="w-full border border-purple-300 rounded px-2 py-2 text-center text-base focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none" placeholder="È¶¨Áï™" inputMode="numeric" /></div>
                                                    <div><label className="text-xs text-purple-700 font-semibold block mb-1">3ÁùÄ</label><input type="number" min="1" max={horseCount} value={raceResult.third} onChange={(e) => setRaceResult(prev => ({ ...prev, third: e.target.value }))} className="w-full border border-purple-300 rounded px-2 py-2 text-center text-base focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none" placeholder="È¶¨Áï™" inputMode="numeric" /></div>
                                                </div>
                                                <button onClick={checkResults} className="w-full bg-purple-600 text-white font-bold py-2 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2 shadow"><Icons.Award size={18} /> Âà§ÂÆö„ÇíÂÆüË°å</button>
                                            </div>
                                        )}
                                    </div>
                                </section>
                            ) : (
                                <div className="text-center py-12 text-gray-400 bg-white rounded-lg border-2 border-dashed border-gray-200">
                                    <Icons.Info className="mx-auto mb-2 opacity-50" />
                                    <p>„Åæ„Å†Ë≤∑„ÅÑÁõÆ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <p className="text-xs mt-1">È¶¨„ÇíÈÅ∏„Çì„Åß„Äå‰∏ã„ÅÆ„É™„Çπ„Éà„Å´ËøΩÂä†„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                </div>
                            )}
                        </main>
                    )}

                    {currentView === 'history' && (
                        <main className="max-w-3xl mx-auto p-4 space-y-4">
                            <div className="flex items-center gap-2 mb-4"><button onClick={() => setCurrentView('calculator')} className="p-2 bg-white rounded-full shadow hover:bg-gray-100"><Icons.ArrowLeft size={20} className="text-gray-600" /></button><h2 className="text-xl font-bold text-gray-700">‰øùÂ≠òÊ∏à„ÅøÂ±•Ê≠¥</h2></div>
                            {savedHistory.length === 0 ? (<div className="text-center py-12 text-gray-400 bg-white rounded-lg"><Icons.History className="mx-auto mb-2 opacity-50" size={48} /><p>‰øùÂ≠ò„Åï„Çå„ÅüÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>) : (
                                <div className="space-y-4">
                                    {savedHistory.map((entry) => {
                                        const betCount = entry.data.betList?.length || 0;
                                        const hasOdds = entry.data.oddsData && Object.keys(entry.data.oddsData).length > 0;
                                        return (
                                            <div key={entry.id} className="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
                                                <div className="flex justify-between items-start mb-3"><div className="flex-1"><div className="flex items-center gap-2 mb-1"><span className="font-bold text-lg text-gray-800">{entry.meta.place} {entry.meta.raceNum}R</span><span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded border">{formatDate(entry.meta.date)}</span></div>{entry.meta.note && (<p className="text-sm text-gray-500 flex items-center gap-1"><Icons.FileText size={12} /> {entry.meta.note}</p>)}</div><div className="text-right"><span className="block text-xs text-gray-500">‰∫àÁÆó</span><span className="font-bold text-emerald-600">{parseInt(entry.data.totalBudget).toLocaleString()}ÂÜÜ</span></div></div>
                                                <div className="grid grid-cols-2 gap-2 text-xs mb-3"><div className="bg-gray-50 p-2 rounded"><span className="text-gray-500">Ë≤∑„ÅÑÁõÆ:</span><span className="font-bold ml-1">{betCount}ÁÇπ</span></div><div className="bg-gray-50 p-2 rounded"><span className="text-gray-500">„É¢„Éº„Éâ:</span><span className="font-bold ml-1">{entry.data.allocationMode === 'profit' ? 'ÊâïÊàªÂùáÁ≠â' : 'Ë≥áÈáëÂùáÁ≠â'}</span></div></div>
                                                {hasOdds && (<div className="text-xs text-blue-600 bg-blue-50 p-2 rounded mb-3">‚úì „Ç™„ÉÉ„Ç∫„Éá„Éº„Çø‰øùÂ≠òÊ∏à„Åø</div>)}
                                                <div className="flex gap-2"><button onClick={() => loadFromHistory(entry)} className="flex-1 bg-emerald-600 text-white py-2 rounded text-sm font-bold hover:bg-emerald-700 flex items-center justify-center gap-1"><Icons.RefreshCw size={14} /> Ë™≠„ÅøËæº„ÇÄ</button><button onClick={() => deleteHistoryItem(entry.id)} className="px-3 bg-white border border-gray-300 text-gray-500 rounded hover:bg-red-50 hover:text-red-500 hover:border-red-300"><Icons.Trash2 size={16} /></button></div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </main>
                    )}

                    {currentView === 'stats' && (
                        <main className="max-w-3xl mx-auto p-4 space-y-4">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setCurrentView('calculator')} className="p-2 bg-white rounded-full shadow hover:bg-gray-100"><Icons.ArrowLeft size={20} className="text-gray-600" /></button>
                                    <h2 className="text-xl font-bold text-gray-700">ÂèéÊîØÁµ±Ë®à</h2>
                                </div>
                                {/* Áµ±Ë®à„Éá„Éº„ÇøÂâäÈô§„Éú„Çø„É≥ */}
                                {resultHistory.length > 0 && (
                                    <button onClick={clearStats} className="text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded border border-red-200 hover:bg-red-100 flex items-center gap-1 transition-colors">
                                        <Icons.Trash2 size={14} />
                                        „Éá„Éº„ÇøÂâäÈô§
                                    </button>
                                )}
                            </div>
                            {resultHistory.length === 0 ? (<div className="text-center py-12 text-gray-400 bg-white rounded-lg border-2 border-dashed border-gray-200"><Icons.BarChart className="mx-auto mb-2 opacity-50" size={48} /><p>„Åæ„Å†ÁöÑ‰∏≠Âà§ÂÆö„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p><p className="text-xs mt-1">„É¨„Éº„Çπ„ÅÆÁµêÊûú„ÇíÂÖ•Âäõ„Åó„Å¶Ë®òÈå≤„ÇíËìÑÁ©ç„Åó„Åæ„Åó„Çá„ÅÜ</p></div>) : (
                                <div className="space-y-4">
                                    <div className="bg-white rounded-lg shadow p-4"><h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2"><Icons.TrendingUp size={18} /> ÂÖ®‰ΩìÊàêÁ∏æ</h3><div className="grid grid-cols-2 gap-4"><div className="bg-blue-50 p-3 rounded"><div className="text-xs text-blue-600 mb-1">Á∑è„É¨„Éº„ÇπÊï∞</div><div className="text-2xl font-bold text-blue-900">{resultHistory.length}</div></div><div className="bg-green-50 p-3 rounded"><div className="text-xs text-green-600 mb-1">ÁöÑ‰∏≠Áéá</div><div className="text-2xl font-bold text-green-900">{((resultHistory.reduce((sum, r) => sum + r.winCount, 0) / resultHistory.reduce((sum, r) => sum + r.totalBets, 0)) * 100).toFixed(1)}%</div></div><div className="bg-purple-50 p-3 rounded"><div className="text-xs text-purple-600 mb-1">Á∑èÊäïË≥áÈ°ç</div><div className="text-2xl font-bold text-purple-900">{resultHistory.reduce((sum, r) => sum + r.totalInvested, 0).toLocaleString()}ÂÜÜ</div></div><div className={`p-3 rounded ${resultHistory.reduce((sum, r) => sum + r.profit, 0) >= 0 ? 'bg-emerald-50' : 'bg-red-50'}`}><div className={`text-xs mb-1 ${resultHistory.reduce((sum, r) => sum + r.profit, 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>Á∑èÂèéÊîØ</div><div className={`text-2xl font-bold ${resultHistory.reduce((sum, r) => sum + r.profit, 0) >= 0 ? 'text-emerald-900' : 'text-red-900'}`}>{resultHistory.reduce((sum, r) => sum + r.profit, 0) >= 0 ? '+' : ''}{resultHistory.reduce((sum, r) => sum + r.profit, 0).toLocaleString()}ÂÜÜ</div></div><div className="bg-yellow-50 p-3 rounded col-span-2"><div className="text-xs text-yellow-600 mb-1">ÂõûÂèéÁéá</div><div className="text-2xl font-bold text-yellow-900">{((resultHistory.reduce((sum, r) => sum + r.totalReturn, 0) / resultHistory.reduce((sum, r) => sum + r.totalInvested, 0)) * 100).toFixed(1)}%</div></div></div></div>
                                    <div className="bg-white rounded-lg shadow p-4"><h3 className="font-bold text-gray-700 mb-3">Á´∂È¶¨Â†¥Âà•ÊàêÁ∏æ</h3><div className="space-y-2">{Object.entries(resultHistory.reduce((acc, r) => { if (!acc[r.place]) { acc[r.place] = { count: 0, invested: 0, returned: 0, profit: 0 }; } acc[r.place].count++; acc[r.place].invested += r.totalInvested; acc[r.place].returned += r.totalReturn; acc[r.place].profit += r.profit; return acc; }, {})).map(([place, stats]) => (<div key={place} className="flex items-center justify-between p-2 bg-gray-50 rounded"><div className="flex-1"><div className="font-semibold">{place}</div><div className="text-xs text-gray-500">{stats.count}„É¨„Éº„Çπ</div></div><div className="text-right"><div className={`font-bold ${stats.profit >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{stats.profit >= 0 ? '+' : ''}{stats.profit.toLocaleString()}ÂÜÜ</div><div className="text-xs text-gray-500">ÂõûÂèéÁéá {((stats.returned / stats.invested) * 100).toFixed(1)}%</div></div></div>))}</div></div>
                                    <div className="bg-white rounded-lg shadow p-4"><h3 className="font-bold text-gray-700 mb-3">ÂºèÂà•ÊàêÁ∏æ</h3><div className="space-y-2">{Object.entries(resultHistory.reduce((acc, r) => { r.bets.forEach(bet => { if (!acc[bet.type]) { acc[bet.type] = { count: 0, wins: 0, invested: 0, returned: 0 }; } acc[bet.type].count++; if (bet.isWin) { acc[bet.type].wins++; acc[bet.type].returned += bet.stake * bet.odds; } acc[bet.type].invested += bet.stake; }); return acc; }, {})).map(([type, stats]) => { const typeName = { 'tansho': 'ÂçòÂãù', 'fukusho': 'Ë§áÂãù', 'wide': '„ÉØ„Ç§„Éâ', 'umaren': 'È¶¨ÈÄ£', 'umatan': 'È¶¨Âçò', 'sanrenpuku': '3ÈÄ£Ë§á', 'sanrentan': '3ÈÄ£Âçò' }[type] || type; return (<div key={type} className="flex items-center justify-between p-2 bg-gray-50 rounded"><div className="flex-1"><div className="font-semibold">{typeName}</div><div className="text-xs text-gray-500">{stats.count}ÁÇπ / ÁöÑ‰∏≠{stats.wins}ÁÇπ ({((stats.wins / stats.count) * 100).toFixed(1)}%)</div></div><div className="text-right"><div className={`font-bold ${stats.returned - stats.invested >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{stats.returned - stats.invested >= 0 ? '+' : ''}{(stats.returned - stats.invested).toLocaleString()}ÂÜÜ</div><div className="text-xs text-gray-500">ÂõûÂèéÁéá {((stats.returned / stats.invested) * 100).toFixed(1)}%</div></div></div>); })}</div></div>
                                    <div className="bg-white rounded-lg shadow p-4"><h3 className="font-bold text-gray-700 mb-3">ÂèéÊîØÊé®Áßª</h3><div className="h-48 flex items-end gap-1">{resultHistory.slice(-20).map((r, i) => { const maxProfit = Math.max(...resultHistory.slice(-20).map(r => Math.abs(r.profit))); const height = (Math.abs(r.profit) / maxProfit) * 100; return (<div key={i} className="flex-1 flex flex-col items-center group relative"><div className={`w-full rounded-t transition-all ${r.profit >= 0 ? 'bg-emerald-500' : 'bg-red-500'}`} style={{ height: `${Math.max(height, 5)}%` }}></div><div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">{r.date}<br/>{r.profit >= 0 ? '+' : ''}{r.profit.toLocaleString()}ÂÜÜ</div></div>); })}</div><div className="text-xs text-gray-500 text-center mt-2">Áõ¥Ëøë{Math.min(resultHistory.length, 20)}„É¨„Éº„Çπ„ÅÆÂèéÊîØ</div></div>
                                </div>
                            )}
                        </main>
                    )}

                    {currentView === 'courseData' && (
                        <main className="max-w-3xl mx-auto p-4 space-y-4">
                            <div className="flex items-center gap-2 mb-4"><button onClick={() => setCurrentView('calculator')} className="p-2 bg-white rounded-full shadow hover:bg-gray-100"><Icons.ArrowLeft size={20} className="text-gray-600" /></button><h2 className="text-xl font-bold text-gray-700">„Ç≥„Éº„Çπ„Éá„Éº„Çø</h2></div>
                            
                            {/* „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Éú„Çø„É≥ */}
                            <div className="bg-white p-4 rounded-lg shadow mb-4">
                                <h3 className="font-bold text-gray-700 mb-2 text-sm">„Ç≥„Éº„Çπ„Éá„Éº„Çø (JSON) „ÇíË™≠„ÅøËæº„ÇÄ</h3>
                                <label className="flex items-center gap-2 p-2 border border-dashed border-gray-300 rounded cursor-pointer hover:bg-gray-50 text-sm text-gray-600">
                                    <Icons.Upload size={18} />
                                    „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                                    <input type="file" accept=".json" onChange={handleFileUpload} className="hidden" />
                                </label>
                            </div>

                            {Object.keys(courseData).length === 0 ? (
                                <div className="text-center py-12 text-gray-400">
                                    <p>„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                                </div>
                            ) : (
                                <div className="space-y-4">{Object.entries(courseData).map(([place, courses]) => (<div key={place} className="space-y-3"><h3 className="text-lg font-bold text-gray-800 bg-emerald-100 px-3 py-2 rounded">{place}</h3><div className="space-y-2">{Object.entries(courses).map(([courseName, data]) => (<CourseAccordion key={place + '-' + courseName} courseName={courseName} data={data} />))}</div></div>))}</div>
                            )}
                        </main>
                    )}
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HorseRacingOddsManager />);
    </script>
</body>
</html>
